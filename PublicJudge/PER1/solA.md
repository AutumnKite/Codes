为方便叙述，我们先假设树以 $v$ 为根。令 $h=\lfloor\frac{d-1}{2}\rfloor$。我们称距离 $v$ 为 $d$ 的点为“候选点”。

考虑一条从 $v$ 出发的最长链，B 的策略一定是沿这条链走 $h$ 步。假设 B 走到了 $u$，则 A 此时一定在 $u$ 的某棵存在“候选点”的子树中。

接下来 B 的策略有两种：

- 往回走，即回到 $u$ 的父亲。
- 往 $u$ 的某棵不存在“候选点”的子树中走。

然后找到最长的路径一直走即可。显然这个过程中 A 一定追不到 B。

考虑从 $v$ 出发的最长链一定是到直径的某个端点，所以我们可以分别以直径两个端点为根，上述过程可以简单的维护。

时间复杂度 $O((n+q)\log n)$。